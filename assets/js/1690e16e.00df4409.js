"use strict";(self.webpackChunkkuby_docs=self.webpackChunkkuby_docs||[]).push([[511],{3905:function(e,t,r){r.d(t,{Zo:function(){return p},kt:function(){return g}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),u=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},p=function(e){var t=u(e.components);return n.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(r),g=a,k=d["".concat(s,".").concat(g)]||d[g]||c[g]||o;return r?n.createElement(k,i(i({ref:t},p),{},{components:r})):n.createElement(k,i({ref:t},p))}));function g(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var u=2;u<o;u++)i[u]=r[u];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},9293:function(e,t,r){r.r(t),r.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return g},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return c}});var n=r(7462),a=r(3366),o=(r(7294),r(3905)),i=["components"],l={id:"quick-start-guide",title:"Quick Start Guide",sidebar_label:"Quick Start Guide",slug:"/"},s=void 0,u={unversionedId:"quick-start-guide",id:"quick-start-guide",title:"Quick Start Guide",description:"Getting your Rails app set up to work with Kuby is pretty straightforward. Here's a quick overview of the necessary steps:",source:"@site/docs/quick_start_guide.md",sourceDirName:".",slug:"/",permalink:"/docs/",editUrl:"https://github.com/getkuby/kuby-core/edit/master/docs/docs/quick_start_guide.md",tags:[],version:"current",frontMatter:{id:"quick-start-guide",title:"Quick Start Guide",sidebar_label:"Quick Start Guide",slug:"/"},sidebar:"sidebar",previous:{title:"Why Docker and Kubernetes?",permalink:"/docs/why"},next:{title:"After the Deploy",permalink:"/docs/after-the-deploy"}},p={},c=[{value:"Installing Docker",id:"installing-docker",level:2},{value:"Choosing a Provider",id:"choosing-a-provider",level:2},{value:"Choosing a Docker Registry",id:"choosing-a-docker-registry",level:2},{value:"Docker Hub",id:"docker-hub",level:3},{value:"Gitlab",id:"gitlab",level:3},{value:"GitHub",id:"github",level:3},{value:"Adding Kuby to your Bundle",id:"adding-kuby-to-your-bundle",level:2},{value:"Configuring Kuby",id:"configuring-kuby",level:2},{value:"Using the Rails Generator",id:"using-the-rails-generator",level:3},{value:"Manual Configuration",id:"manual-configuration",level:3},{value:"Deploy Environments",id:"deploy-environments",level:3},{value:"Configuring Docker",id:"configuring-docker",level:3},{value:"Configuring Kubernetes",id:"configuring-kubernetes",level:3},{value:"Providers",id:"providers",level:4},{value:"Plugins",id:"plugins",level:4},{value:"Database Credentials",id:"database-credentials",level:4},{value:"Deploying",id:"deploying",level:2}],d={toc:c};function g(e){var t=e.components,r=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,n.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Getting your Rails app set up to work with Kuby is pretty straightforward. Here's a quick overview of the necessary steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Install Docker"),(0,o.kt)("li",{parentName:"ol"},"Choose a hosting provider"),(0,o.kt)("li",{parentName:"ol"},"Choose a Docker registry"),(0,o.kt)("li",{parentName:"ol"},"Add the Kuby gems to your bundle"),(0,o.kt)("li",{parentName:"ol"},"Configure Kuby"),(0,o.kt)("li",{parentName:"ol"},"Deploy!")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE"),": Kuby is designed to work with Rails 5.1 and up."),(0,o.kt)("h2",{id:"installing-docker"},"Installing Docker"),(0,o.kt)("p",null,"The easiest way to install Docker for MacOS and Windows is via ",(0,o.kt)("a",{parentName:"p",href:"https://www.docker.com/products/docker-desktop"},"Docker Desktop"),". You will need Docker to build and push the Docker image for your application (described below)."),(0,o.kt)("h2",{id:"choosing-a-provider"},"Choosing a Provider"),(0,o.kt)("p",null,"The first step in deploying your app is to choose a hosting provider. At the time of this writing, Kuby supports ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/getkuby/kuby-digitalocean"},"DigitalOcean"),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/getkuby/kuby-linode"},"Linode"),", ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/getkuby/kuby-azure"},"Azure"),", and Amazon's ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/getkuby/kuby-eks"},"EKS"),". Use your provider's dashboard to spin up a Kubernetes cluster. In most cases, this shouldn't involve more than a few button clicks, although for more customizable providers like EKS and Azure you might want to look for specific guides online."),(0,o.kt)("h2",{id:"choosing-a-docker-registry"},"Choosing a Docker Registry"),(0,o.kt)("p",null,"Kuby uses Docker to package up your application into a Docker ",(0,o.kt)("em",{parentName:"p"},"image"),'. Images are then pushed (i.e. uploaded) to something called a "registry." Registries host Docker images so they can be pulled (i.e. downloaded) by the servers that will eventually run them.'),(0,o.kt)("h3",{id:"docker-hub"},"Docker Hub"),(0,o.kt)("p",null,"There are a number of Docker registries available, some free and some paid. Docker's own offering is called ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/"},"Docker Hub"),", the de-facto registry for open-source projects and commercial solutions alike. Images hosted on Docker Hub are referred to using an abbreviated URL without a hostname, i.e. ",(0,o.kt)("inlineCode",{parentName:"p"},"<username>/<repo>"),". If you see an image referred to like this, it means it's hosted on Docker Hub."),(0,o.kt)("h3",{id:"gitlab"},"Gitlab"),(0,o.kt)("p",null,"Gitlab's Docker registry is a great alternative to Docker Hub. It's free and unlimited. Oh, and a quick note: you don't have to host your code on Gitlab to take advantage of the registry, but they're great for that too."),(0,o.kt)("p",null,"Images hosted on 3rd-party registries (i.e. not on Docker Hub) are referred to by their full URL. If you choose to use Gitlab's Docker registry, the URL to your Docker image will look like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"registry.gitlab.com/<username>/<repo>\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE"),": Gitlab's Docker registry requires you to authenticate using a personal or deploy access token instead of your Gitlab password. See their ",(0,o.kt)("a",{parentName:"p",href:"https://docs.gitlab.com/ee/user/packages/container_registry/#authenticate-with-the-container-registry"},"documentation")," for more information."),(0,o.kt)("h3",{id:"github"},"GitHub"),(0,o.kt)("p",null,"GitHub runs a docker registry, available at docker.pkg.github.com. As with Gitlab, you'll need to refer to the registry using the full URL. The URL should be of the format ",(0,o.kt)("inlineCode",{parentName:"p"},":username/:repo/:image_name"),", so your URL will look something like"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"docker.pkg.github.com/<username>/<repo>/<image-name>\n")),(0,o.kt)("p",null,"You'll also need to get Docker to log in to the registry using a token with the correct access permissions; you can find out more in ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/articles/configuring-docker-for-use-with-github-package-registry/"},"the Github package documenation"),"."),(0,o.kt)("h2",{id:"adding-kuby-to-your-bundle"},"Adding Kuby to your Bundle"),(0,o.kt)("p",null,"Add the kuby-core gem and the corresponding gem for your chosen provider to your Rails application's Gemfile, for example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"gem 'kuby-core', '< 1.0'\ngem 'kuby-digitalocean', '< 1.0'\n")),(0,o.kt)("p",null,"Run ",(0,o.kt)("inlineCode",{parentName:"p"},"bundle install")," to install the gems."),(0,o.kt)("h2",{id:"configuring-kuby"},"Configuring Kuby"),(0,o.kt)("p",null,"All Kuby configuration is written in Ruby and lives in a file called kuby.rb in your application's root directory."),(0,o.kt)("h3",{id:"using-the-rails-generator"},"Using the Rails Generator"),(0,o.kt)("p",null,"Rather than follow all the steps below, feel free to make use of Kuby's Rails generator, which will create all the files you need and put them in the right places. Just run"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"bundle exec rails generate kuby\n")),(0,o.kt)("p",null,"and follow the prompts."),(0,o.kt)("h3",{id:"manual-configuration"},"Manual Configuration"),(0,o.kt)("p",null,"Kuby configuration is done via a ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Domain-specific_language"},"DSL"),". There are two main sections, one for Docker and one for Kubernetes. Put the config into a file called kuby.rb in the root directory of your Rails app."),(0,o.kt)("p",null,"Here's what a complete config looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"require 'kuby/digitalocean'\n\nrequire 'active_support/core_ext'\nrequire 'active_support/encrypted_configuration'\n\nKuby.define('my-app') do\n  app_creds = ActiveSupport::EncryptedConfiguration.new(\n    config_path: File.join('config', 'credentials.yml.enc'),\n    key_path: File.join('config', 'master.key'),\n    env_key: 'RAILS_MASTER_KEY',\n    raise_if_missing_key: true\n  )\n\n  environment(:production) do\n    docker do\n      credentials do\n        username app_creds[:DOCKER_USERNAME]\n        password app_creds[:DOCKER_PASSWORD]\n        email app_creds[:DOCKER_EMAIL]\n      end\n\n      image_url 'registry.gitlab.com/username/repo'\n    end\n\n    kubernetes do\n      provider :digitalocean do\n        access_token app_creds[:DIGITALOCEAN_ACCESS_TOKEN]\n        cluster_id 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'\n      end\n\n      add_plugin :rails_app do\n        hostname 'mywebsite.com'\n      end\n    end\n  end\nend\n")),(0,o.kt)("p",null,"Create a Rails initializer at config/initializers/kuby.rb that loads your Kuby config:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"require 'kuby'\nKuby.load!\n")),(0,o.kt)("p",null,"Let's go over this config in detail."),(0,o.kt)("h3",{id:"deploy-environments"},"Deploy Environments"),(0,o.kt)("p",null,"The first line tells Kuby what you want to call your app:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"Kuby.define('my-app')\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"NOTE"),": The next block loads your Rails credentials file. Since your Rails environment may or may not be loaded when your Kuby config loads, we have to access Rails credentials manually."),(0,o.kt)("p",null,"The second line defines the ",(0,o.kt)("em",{parentName:"p"},"deploy environment"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"environment(:production)\n")),(0,o.kt)("p",null,'Deploy environments usually closely mirror your Rails environments. For example, you might create a new Rails environment called "staging" or "preprod" that\'s used to test production changes before they go live.'),(0,o.kt)("p",null,'If you\'re a small shop or hobbyist though, chances are the "production" deploy environment is all you need.'),(0,o.kt)("h3",{id:"configuring-docker"},"Configuring Docker"),(0,o.kt)("p",null,'Kuby can automatically "dockerize" your application. You just need to tell it where to push images and provide some credentials:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"docker do\n  credentials do\n    username app_creds[:DOCKER_USERNAME]\n    password app_creds[:DOCKER_PASSWORD]\n    email app_creds[:DOCKER_EMAIL]\n  end\n\n  image_url 'registry.gitlab.com/username/repo'\nend\n")),(0,o.kt)("p",null,"The username, password, and email fields are used to authenticate with the Docker registry that hosts your images. For GitHub and Gitlab, you'll need to create a personal access token instead of using your password. Here are the docs for ",(0,o.kt)("a",{parentName:"p",href:"https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html"},"Gitlab")," and here are the docs for ",(0,o.kt)("a",{parentName:"p",href:"https://docs.github.com/articles/configuring-docker-for-use-with-github-package-registry/"},"GitHub"),". The ",(0,o.kt)("inlineCode",{parentName:"p"},"image_url")," field is the full URL to your Docker image, including the registry's domain."),(0,o.kt)("p",null,"In the example above, the username, password, and email are all provided by Rails' ",(0,o.kt)("a",{parentName:"p",href:"https://guides.rubyonrails.org/v5.2/security.html#custom-credentials"},"encrypted credentials")," feature. It's important to remember to ",(0,o.kt)("strong",{parentName:"p"},"NEVER")," hard-code sensitive information (like passwords) in your Kuby config or check it into source control (i.e. git). If you'd rather not use encrypted credentials, consider using a tool like ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/bkeepers/dotenv"},"dotenv")," to automatically load your secrets into environment variables when your app starts (NOTE: don't check the .env file into git either!)"),(0,o.kt)("h3",{id:"configuring-kubernetes"},"Configuring Kubernetes"),(0,o.kt)("p",null,"Now that your app can be packaged up into a Docker image, it's time to use Kubernetes to run it. There are two top-level concerns in the Kubernetes section of your Kuby config: providers and plugins."),(0,o.kt)("h4",{id:"providers"},"Providers"),(0,o.kt)("p",null,"Each Kubernetes definition must have a provider configured. Providers correspond to the hosting provider you chose earlier. For example, you'll need to add the ",(0,o.kt)("inlineCode",{parentName:"p"},":digitalocean")," provider to deploy to a managed DigitalOcean Kubernetes cluster."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"kubernetes do\n  provider :digitalocean do\n    access_token app_creds[:DIGITALOCEAN_ACCESS_TOKEN]\n    cluster_id 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'\n  end\nend\n")),(0,o.kt)("p",null,"Providers can have different config options, so make sure you consult the gem's README for the provider you've chosen."),(0,o.kt)("h4",{id:"plugins"},"Plugins"),(0,o.kt)("p",null,"Nearly all Kuby's functionality is provided via plugins. For example, simply add the ",(0,o.kt)("inlineCode",{parentName:"p"},":rails_app")," plugin to get your Rails app ready to deploy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"add_plugin :rails_app\n")),(0,o.kt)("p",null,"To indicate your app serves a particular domain name, specify the ",(0,o.kt)("inlineCode",{parentName:"p"},"hostname")," option:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ruby"},"add_plugin :rails_app do\n  hostname 'mywebsite.com'\nend\n")),(0,o.kt)("p",null,"Configuring DNS to point to your Kubernetes cluster is outside the scope of this guide, but all the hosting providers should have tutorials readily available. For example, ",(0,o.kt)("a",{parentName:"p",href:"https://www.digitalocean.com/community/tutorials/how-to-point-to-digitalocean-nameservers-from-common-domain-registrars"},"here's the one")," from DigitalOcean."),(0,o.kt)("h4",{id:"database-credentials"},"Database Credentials"),(0,o.kt)("p",null,"You may have noticed our Kuby config doesn't contain any mention of database credentials. That's because Kuby automatically creates a set of TLS certificates for communicating with the database instance. Not only is this technique more secure, it's less configuration to worry about. Win win!"),(0,o.kt)("h2",{id:"deploying"},"Deploying"),(0,o.kt)("p",null,"Now that Kuby is configured and your Kubernetes cluster is ready, it's time to deploy!"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Build the Docker image"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"RAILS_MASTER_KEY=<your master key> bundle exec kuby -e production build\n")),(0,o.kt)("p",{parentName:"li"},"If your master key is stored in the default location (",(0,o.kt)("inlineCode",{parentName:"p"},"config/master.key"),"), you can run ",(0,o.kt)("inlineCode",{parentName:"p"},"bundle exec kuby")," without setting the ",(0,o.kt)("inlineCode",{parentName:"p"},"RAILS_MASTER_KEY")," variable.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Push the Docker image to the container registry"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"bundle exec kuby -e production push\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Set up your provider"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"bundle exec kuby -e production setup\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Deploy!"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"RAILS_MASTER_KEY=<your master key> bundle exec kuby -e production deploy\n")),(0,o.kt)("p",{parentName:"li"},"As above, ",(0,o.kt)("inlineCode",{parentName:"p"},"RAILS_MASTER_KEY")," is only required if your key is not stored at ",(0,o.kt)("inlineCode",{parentName:"p"},"config/master.key"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Rejoice"))))}g.isMDXComponent=!0}}]);